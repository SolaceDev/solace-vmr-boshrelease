#!/bin/bash

set -e

function parse_url()
{
# Regex Groups are as follow:
#   protocol : 2
#   user : 5 or 7 (7 means no password)
#   password : 6
#   host: 8
#   port: 10
  regex="^(^(.*)://)?((([^:@]+):([^@]+)@)|([^@]+)@)?([^:]+)(:([^\/]+))?(/.*)?"

  if [[ $url =~ $regex ]]
  then
    protocol=${BASH_REMATCH[2]}
    if [ -z ${BASH_REMATCH[5]} ]
    then
      user=${BASH_REMATCH[7]}
    else
      user=${BASH_REMATCH[5]}
    fi
    password=${BASH_REMATCH[6]}
    host=${BASH_REMATCH[8]}
    port=${BASH_REMATCH[10]}
  else
    echo "This url was invalid: $url"
    exit 1
  fi

  protocol=${protocol:-http}
  user=${user:-admin}
  password=${password:-admin}
  port=${port:-8080}

  if [ -z $host ]
  then
    echo "Error parsing $url.  Could not extract the host"
    exit 1
  fi

  echo "VMR for this URI was parsed into:"
  echo "  Protocol: ${protocol}"
  echo "  User: ${user}"
  echo "  Password: ${password}"
  echo "  Host: ${host}"
  echo "  Port: ${port}"
}

cd /var/vcap/packages/vmr_config_scripts

tar zxf vmr_config_scripts.tgz
cd vmr_config_scripts
export PATH=`pwd`:$PATH
export HOME=`pwd`

chmod +x rs-config-vmr-for-maas
chown root:root PCF-PoC.pem
chmod 600 PCF-PoC.pem

echo "dedicated_vmr_list = <%= properties.dedicated_vmr_list %>"
echo "shared_vmr_list = <%= properties.shared_vmr_list %>"
echo "starting_port = <%= properties.starting_port %>"
echo "broker_user = <%= properties.broker_user %>"
echo "broker_password = <%= properties.broker_password %>"
echo "broker_hostname = <%= properties.broker_hostname %>"

# Installs perl modules required to run rs scripts, and jq so we
# are able to easily parse JSON from this bash script
sudo apt-get install -y libexpect-perl libterm-readkey-perl sshpass

<% dedicated_uris = properties.dedicated_vmr_list.split(",") %>
<% shared_uris = properties.shared_vmr_list.split(",") %>
starting_port=<%= properties.starting_port %>

# Hardcoded for First release.
ssh_port=22

<% dedicated_uris.each do |vmr_uri| %>
url=<%= vmr_uri %>
parse_url

echo "Configuring $url as a Dedicated VMR"

#Generate a random password for the file user of this VMR
fileuser_pwd=`openssl rand -base64 12`

echo "This VMR's file user credentials are : fileuser / $fileuser_pwd"

./rs-config-vmr-for-maas --cli-username $user --cli-authkey PCF-PoC.pem --cli-password $password $host:$ssh_port plan=dedicated portSeed=$starting_port fileUserPass=$fileuser_pwd adminPass=$password

echo "Uploading server certificate to $url, and installing certificate on Message Router"
sshpass -p "$fileuser_pwd" scp -P $ssh_port server.pem fileuser@$host:/certs
./rs-config-server-cert --cli-username $user --cli-authkey PCF-PoC.pem --cli-password $password $host:$ssh_port certificate="server.pem"
<% end %>

<% shared_uris.each do |vmr_uri| %>
url=<%= vmr_uri %>
parse_url

echo "Configuring $url as a Shared VMR"

#Generate a random password for the file user of this VMR
fileuser_pwd=`openssl rand -base64 12`

echo "This VMR's file user credentials are : fileuser / $fileuser_pwd"

./rs-config-vmr-for-maas --cli-username $user --cli-authkey PCF-PoC.pem --cli-password $password $host:$ssh_port plan=shared portSeed=$starting_port fileUserPass=$fileuser_pwd adminPass=$password

echo "Uploading server certificate to $url, and installing certificate on Message Router"
sshpass -p "$fileuser_pwd" scp -P $ssh_port server.pem fileuser@$host:/certs
./rs-config-server-cert --cli-username $user --cli-authkey PCF-PoC.pem --cli-password $password $host:$ssh_port certificate="server.pem"
<% end %>
