#!/bin/bash

set -e

cd /var/vcap/packages/config_vmr
export PATH=`pwd`:$PATH

tar zxf config_vmr.tgz

echo "dedicated_vmr_list = <%= properties.dedicated_vmr_list %>"
echo "shared_vmr_list = <%= properties.shared_vmr_list %>"
echo "broker_user = <%= properties.broker_user %>"
echo "broker_password = <%= properties.broker_password %>"
echo "broker_hostname = <%= properties.broker_hostname %>"

# Installs perl modules required to run rs scripts, and jq so we
# are able to easily parse JSON from this bash script
sudo apt-get install -y libexpect-perl libterm-readkey-perl

<% dedicated_uris = properties.dedicated_vmr_list.split(",") %>
<% shared_uris = properties.shared_vmr_list.split(",") %>

<% dedicated_uris.each do |vmr_uri| -%>
./rs-config-vmr-for-maas <%= vmr_uri %> plan=dedicated
<% end -%>

<% shared_uris.each do |vmr_uri| -%>
./rs-config-vmr-for-maas <%= vmr_uri %> plan=shared
<% end -%>